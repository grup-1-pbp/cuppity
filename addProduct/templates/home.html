{% extends 'base.html' %}
{% load static %}

{% block meta %}
<title>Mangan-Yuk Food List</title>
{% endblock meta %}

{% block content %}
<h1>Selamat Datang di Mangan-Yuk</h1>
<p>Selamat datang, {{ request.user.username }}!</p>

<!-- Button to trigger the modal -->
<button onclick="showFoodModal();">Tambah Makanan Baru by AJAX</button>

<!-- Modal for AJAX Food Entry -->
<div id="foodModal" class="hidden fixed inset-0 z-50 w-full flex items-center justify-center bg-gray-800 bg-opacity-50 overflow-x-hidden overflow-y-auto transition-opacity duration-300 ease-out">
  <div id="foodModalContent" class="relative bg-white rounded-lg shadow-lg w-5/6 sm:w-3/4 md:w-1/2 lg:w-1/3 mx-4 sm:mx-0 transform scale-95 opacity-0 transition-transform transition-opacity duration-300 ease-out">
    <div class="flex items-center justify-between p-4 border-b rounded-t">
      <h3 class="text-xl font-semibold text-gray-900">Add New Food Entry</h3>
      <button type="button" class="text-gray-400 bg-transparent hover:bg-gray-200 hover:text-gray-900 rounded-lg text-sm p-1.5 ml-auto inline-flex items-center" onclick="hideFoodModal();">
        <svg aria-hidden="true" class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
          <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 1 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path>
        </svg>
        <span class="sr-only">Close modal</span>
      </button>
    </div>

    <!-- Modal body for form -->
    <div class="px-6 py-4 space-y-6">
      <form id="foodForm">
        <div class="mb-4">
          <label for="food_name" class="block text-sm font-medium text-gray-700">Food Name</label>
          <input type="text" id="food_name" name="name" class="mt-1 block w-full border border-gray-300 rounded-md p-2" placeholder="Enter food name" required>
        </div>
        <div class="mb-4">
          <label for="restaurant" class="block text-sm font-medium text-gray-700">Restaurant</label>
          <input type="text" id="restaurant" name="restaurant" class="mt-1 block w-full border border-gray-300 rounded-md p-2" placeholder="Enter restaurant" required>
        </div>
        <div class="mb-4">
          <label for="price" class="block text-sm font-medium text-gray-700">Price</label>
          <input type="number" id="price" name="price" class="mt-1 block w-full border border-gray-300 rounded-md p-2" placeholder="Enter price" required>
        </div>
        <div class="mb-4">
          <label for="preference" class="block text-sm font-medium text-gray-700">Preference</label>
          <select id="preference" name="preference" class="mt-1 block w-full border border-gray-300 rounded-md p-2" required>
            <option value="Indo">Indonesia</option>
            <option value="Chin">Chinese</option>
            <option value="West">Western</option>
          </select>
        </div>
        <div class="mb-4">
          <label for="image_url" class="block text-sm font-medium text-gray-700">Image URL</label>
          <input type="url" id="image_url" name="image_url" class="mt-1 block w-full border border-gray-300 rounded-md p-2" placeholder="Enter image URL" required>
        </div>
      </form>
    </div>

    <!-- Modal footer for form submit button -->
    <div class="flex justify-end p-4 border-t border-gray-200 rounded-b">
      <button type="button" class="bg-gray-500 text-white font-bold py-2 px-4 rounded-lg mr-2" onclick="hideFoodModal();">Cancel</button>
      <button type="submit" form="foodForm" class="bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg">Save</button>
    </div>
  </div>
</div>

<!-- Section to display food items -->
<h2>Daftar Makanan</h2>
<ul id="food_entry_list">
  {% for food in foods %}
    <li>
      <strong>{{ food.name }}</strong><br>
      <p>{{food.id}}</p>
      <img src="{{ food.image_url }}" alt="{{ food.name }}" style="max-width: 150px;"><br>
      Restaurant: {{ food.restaurant }}<br>
      Harga: Rp. {{ food.price }}<br>
      Preference: {{ food.get_preference_display }}<br>
      <a href="{% url 'addProduct:edit_food' food.id %}">EDIT BUTTON</a>
      <a href="{% url 'addProduct:delete_food' food.id %}">DELETE BUTTON</a>
    </li>
  {% empty %}
    <li>No food data available.</li>
  {% endfor %}
</ul>

<script>
    async function getFoodEntries() {
      const response = await fetch("{% url 'addProduct:show_json' %}");
      return response.json();
    }
  
    async function refreshFoodEntries() {
        try {
          const foodEntries = await getFoodEntries();
          console.log(foodEntries);  // Debugging untuk melihat data yang diterima
      
          let htmlString = "";
      
          if (foodEntries.length === 0) {
            htmlString = `<li>No food data available.</li>`;
          } else {
            foodEntries.forEach(food => {
              const name = DOMPurify.sanitize(food.fields.name);
              const restaurant = DOMPurify.sanitize(food.fields.restaurant);
              const price = DOMPurify.sanitize(food.fields.price);
              const preference = DOMPurify.sanitize(food.fields.preference);
              const imageUrl = DOMPurify.sanitize(food.fields.image_url) || 'default-image.jpg';
      
              htmlString += `
                <li>
                  <strong>${name}</strong><br>
                  <img src="${imageUrl}" alt="${name}" style="max-width: 150px;"><br>
                  Restaurant: ${restaurant}<br>
                  Harga: Rp. ${price}<br>
                  Preference: ${preference}<br>
                  <a href="/edit-food/${food.pk}"><button>Edit</button></a>
                  <form action="/delete-food/${food.pk}" method="post" style="display:inline;">
                    <input type="hidden" name="csrfmiddlewaretoken" value="{{ csrf_token }}">
                    <button type="submit">Delete</button>
                  </form>
                </li>
              `;
            });
          }
      
          document.getElementById("food_entry_list").innerHTML = htmlString;
        } catch (error) {
          console.error("Error in refreshing food entries:", error);
        }
      }
      
  
    async function addFoodEntry() {
      const form = document.getElementById('foodForm');
      const formData = new FormData(form);

      console.log([...formData]);  // Debugging for form data

      const response = await fetch("{% url 'addProduct:add_food' %}", {
        method: "POST",
        body: formData,
        headers: { 'X-CSRFToken': '{{ csrf_token }}' }
      });

      console.log(response.status);  // Debugging for response status

      if (response.ok) {
        form.reset();
        hideFoodModal();
        refreshFoodEntries();
      } else {
        console.error("Error submitting form");
      }
      refreshFoodEntries();
    }
  
    function showFoodModal() {
      document.getElementById('foodModal').classList.remove('hidden');
      document.getElementById('foodModalContent').classList.remove('opacity-0', 'scale-95');
      document.getElementById('foodModalContent').classList.add('opacity-100', 'scale-100');
    }
  
    function hideFoodModal() {
      document.getElementById('foodModalContent').classList.remove('opacity-100', 'scale-100');
      document.getElementById('foodModalContent').classList.add('opacity-0', 'scale-95');
      setTimeout(() => document.getElementById('foodModal').classList.add('hidden'), 150);
    }
  
    document.addEventListener("DOMContentLoaded", () => {
      refreshFoodEntries();

      document.getElementById("foodForm").addEventListener("submit", (e) => {
        e.preventDefault();
        addFoodEntry();
      });
    });
</script>
{% endblock content %}
