{% extends 'base.html' %}
{% load static %}

{% block meta %}
<title>Mangan-Yuk Food List</title>
{% endblock meta %}

{% block content %}
{% include 'navbar.html' %}

<div class="mt-6 mb-4">
  <button onclick="showFoodModal();" class="bg-[#F0C868] text-white font-bold text-lg px-5 py-3 rounded-lg flex items-center justify-center w-full max-w-md mx-auto">
    <img src="https://icons.veryicon.com/png/o/miscellaneous/simple-linetype-icon/food-17.png" alt="Food Icon" class="w-6 h-6 mr-3">
    Add New Food
  </button>
</div>

<div class="container mx-auto p-4">
  <h1 class="text-2xl font-bold text-gray-800 mb-4">Food Added</h1>
  
  <!-- Categories Filter -->
  <div class="flex flex-wrap space-x-2 mb-4">
    <button class="bg-gray-200 text-gray-700 px-3 py-1 rounded-full text-sm">Indonesian</button>
    <button class="bg-gray-100 text-gray-600 px-3 py-1 rounded-full text-sm">Chinese</button>
    <button class="bg-gray-100 text-gray-600 px-3 py-1 rounded-full text-sm">Western</button>
    <button class="bg-gray-100 text-gray-600 px-3 py-1 rounded-full text-sm">Japanese</button>
    <button class="bg-gray-100 text-gray-600 px-3 py-1 rounded-full text-sm">Indian</button>
  </div>

  <!-- Modal for AJAX Food Entry -->
  <div id="foodModal" class="hidden fixed inset-0 z-50 w-full flex items-center justify-center bg-gray-800 bg-opacity-50 overflow-x-hidden overflow-y-auto">
    <div id="foodModalContent" class="relative bg-white rounded-lg shadow-lg w-5/6 sm:w-3/4 md:w-1/2 lg:w-1/3 mx-4 sm:mx-0 opacity-0 scale-95 transform transition-all duration-300 ease-out">
      <div class="flex items-center justify-between p-4 border-b rounded-t">
        <h3 class="text-xl font-semibold text-gray-900">Add New Food Entry</h3>
        <button type="button" class="text-gray-400 bg-transparent hover:bg-gray-200 hover:text-gray-900 rounded-lg text-sm p-1.5 ml-auto inline-flex items-center" onclick="hideFoodModal();">
          <svg aria-hidden="true" class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
            <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 1 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path>
          </svg>
          <span class="sr-only">Close modal</span>
        </button>
      </div>

      <!-- Modal body for form -->
      <div class="px-6 py-4 space-y-4">
        <form id="foodForm">
          <div class="mb-4">
            <label for="food_name" class="block text-sm font-medium text-gray-700">Food Name</label>
            <input type="text" id="food_name" name="name" class="mt-1 block w-full border border-gray-300 rounded-md p-2 text-sm" placeholder="Enter food name" required>
          </div>
          <div class="mb-4">
            <label for="restaurant" class="block text-sm font-medium text-gray-700">Restaurant</label>
            <input type="text" id="restaurant" name="restaurant" class="mt-1 block w-full border border-gray-300 rounded-md p-2 text-sm" placeholder="Enter restaurant" required>
          </div>
          <div class="mb-4">
            <label for="price" class="block text-sm font-medium text-gray-700">Price</label>
            <input type="number" id="price" name="price" class="mt-1 block w-full border border-gray-300 rounded-md p-2 text-sm" placeholder="Enter price" required>
          </div>
          <div class="mb-4">
            <label for="preference" class="block text-sm font-medium text-gray-700">Preference</label>
            <select id="preference" name="preference" class="mt-1 block w-full border border-gray-300 rounded-md p-2 text-sm" required>
              <option value="Indonesian">Indonesian</option>
              <option value="Chinese">Chinese</option>
              <option value="Western">Western</option>
            </select>
          </div>
          <div class="mb-4">
            <label for="image_url" class="block text-sm font-medium text-gray-700">Image URL</label>
            <input type="url" id="image_url" name="image_url" class="mt-1 block w-full border border-gray-300 rounded-md p-2 text-sm" placeholder="Enter image URL" required>
          </div>
          <div class="mb-4">
            <label for="deskripsi" class="block text-sm font-medium text-gray-700">Deskripsi</label>
            <textarea id="deskripsi" name="deskripsi" class="mt-1 block w-full border border-gray-300 rounded-md p-2 text-sm" placeholder="Enter description" required></textarea>
          </div>
        </form>
      </div>

      <!-- Modal footer for form submit button -->
      <div class="flex justify-end p-4 border-t border-gray-200 rounded-b">
        <button type="button" class="bg-gray-500 text-white font-bold py-2 px-4 rounded-lg mr-2" onclick="hideFoodModal();">Cancel</button>
        <button type="submit" form="foodForm" class="bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg">Save</button>
      </div>
    </div>
  </div>

  <div id="food_entry_list" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
    {% for food in foods %}
    <div class="bg-white rounded-lg shadow-lg flex flex-col overflow-hidden max-w-lg mx-auto">
      <!-- Image section -->
      <div class="w-full">
        <img src="{{ food.image_url }}" alt="{{ food.name }}" class="object-cover w-full h-64">
      </div>
      <!-- Content section -->
      <div class="flex flex-col justify-between p-6">
        <span class="inline-block bg-gray-200 text-gray-800 text-sm px-2 py-1 rounded-full">{{ food.preference }}</span>
        <h3 class="text-xl font-semibold mt-4">{{ food.name }}</h3>
        <p class="text-gray-600 mt-2 text-base">Rp.{{ food.price }}</p>
        <p class="text-base text-gray-500">{{ food.restaurant }}</p>
        <p class="text-base text-gray-500 mt-3">{{ food.deskripsi }}</p>
        <div class="flex items-center space-x-4 mt-6">
          <a href="{% url 'addProduct:edit_food' food.id %}" class="bg-yellow-500 hover:bg-yellow-600 text-white text-sm font-bold py-2 px-6 rounded-lg">
            <img src="https://cdn-icons-png.flaticon.com/512/176/176318.png" alt="Edit Icon" class="w-5 h-5 mr-2"> Edit
          </a>
          <a href="{% url 'detailmakanan:product_detail' food.id %}" class="bg-blue-500 hover:bg-blue-600 text-white text-sm font-bold py-2 px-6 rounded-lg">
            <img src="https://cdn-icons-png.freepik.com/256/1265/1265775.png?semt=ais_hybrid" alt="Detail Icon" class="w-5 h-5 mr-2"> Detail
          </a>
          <form action="{% url 'addProduct:delete_food' food.id %}" method="post" class="inline">
            {% csrf_token %}
            <button type="submit" class="bg-red-500 hover:bg-red-600 text-white text-sm font-bold py-2 px-6 rounded-lg">
              <img src="https://cdn-icons-png.flaticon.com/512/484/484662.png" alt="Delete Icon" class="w-5 h-5 mr-2"> Delete
            </button>
          </form>
        </div>
      </div>
    </div>
    {% endfor %}
</div>


  <!-- Empty State -->
  {% if not foods %}
  <div class="text-center py-10">
    <p class="text-gray-500">No food data available.</p>
  </div>
  {% endif %}
</div>

<script>
// Function to open the modal form
function showFoodModal() {
    const modal = document.getElementById('foodModal');
    const modalContent = document.getElementById('foodModalContent');
    
    modal.classList.remove('hidden');  // Show modal
    setTimeout(() => {
        modalContent.classList.remove('opacity-0', 'scale-95');  // Start the transition to show modal
        modalContent.classList.add('opacity-100', 'scale-100');
    }, 10);  // A slight delay to trigger the CSS transition
}

// Function to close the modal form
function hideFoodModal() {
    const modal = document.getElementById('foodModal');
    const modalContent = document.getElementById('foodModalContent');
    
    modalContent.classList.remove('opacity-100', 'scale-100');  // Hide modal content first
    modalContent.classList.add('opacity-0', 'scale-95');
    
    setTimeout(() => {
        modal.classList.add('hidden');  // Hide the whole modal after the transition
    }, 300);  // Duration matching the transition (300ms)
}

// Event listener for form submission when the page finishes loading
document.addEventListener("DOMContentLoaded", () => {
    document.getElementById("foodForm").addEventListener("submit", (e) => {
        e.preventDefault();
        addFoodEntry(); // Call addFoodEntry function when the form is submitted
    });
});

// Function to submit food entry
async function addFoodEntry() {
    const form = document.getElementById('foodForm');
    const formData = new FormData(form);
    const submitButton = document.querySelector('[form="foodForm"]');
    submitButton.disabled = true;

    try {
        const response = await fetch("{% url 'addProduct:add_food' %}", {
            method: "POST",
            body: formData,
            headers: {
                'X-CSRFToken': '{{ csrf_token }}'
            }
        });

        const data = await response.json();

        if (response.ok && data.success) {
            form.reset(); // Reset form if successful
            hideFoodModal(); // Close modal
            refreshFoodEntries(); // Refresh food list after success
        } else if (!data.success && data.errors) {
            console.error("Form Validation Errors:", data.errors); // Show validation errors
        } else {
            console.error("Unknown error during form submission.");
        }
    } catch (error) {
        console.error("Error submitting form:", error);
    } finally {
        submitButton.disabled = false; // Re-enable submit button after submission
    }
}

async function refreshFoodEntries() {
  try {
      const response = await fetch("{% url 'addProduct:show_json' %}");
      const foodEntries = await response.json();

      const foodEntryList = document.getElementById("food_entry_list");
      foodEntryList.innerHTML = "";  // Clear the current list

      let htmlString = "";
      if (foodEntries.length === 0) {
          htmlString = `<div class="text-center py-10"><p class="text-gray-500">No food data available.</p></div>`;
      } else {
          foodEntries.forEach(food => {
              htmlString += `
                  <div class="bg-white rounded-lg shadow-lg flex flex-col overflow-hidden max-w-lg mx-auto">
                      <!-- Image section -->
                      <div class="w-full">
                          <img src="${food.fields.image_url || 'default-image.jpg'}" alt="${food.fields.name}" class="object-cover w-full h-64">
                      </div>
                      <!-- Content section -->
                      <div class="flex flex-col justify-between p-6">
                          <span class="inline-block bg-gray-200 text-gray-800 text-sm px-2 py-1 rounded-full">${food.fields.preference}</span>
                          <h3 class="text-xl font-semibold mt-4">${food.fields.name}</h3>
                          <p class="text-gray-600 mt-2 text-base">Rp.${food.fields.price}</p>
                          <p class="text-base text-gray-500">${food.fields.restaurant}</p>
                          <p class="text-base text-gray-500 mt-3">${food.fields.deskripsi}</p>
                          <div class="flex items-center space-x-4 mt-6">
                              <a href="/edit-food/${food.pk}" class="bg-yellow-500 hover:bg-yellow-600 text-white text-sm font-bold py-2 px-6 rounded-lg">
                                  <img src="https://cdn-icons-png.flaticon.com/512/176/176318.png" alt="Edit Icon" class="w-5 h-5 mr-2"> Edit
                              </a>
                              <a href="/detailmakanan/product-detail/${food.pk}" class="bg-blue-500 hover:bg-blue-600 text-white text-sm font-bold py-2 px-6 rounded-lg">
                                  <img src="https://cdn-icons-png.freepik.com/256/1265/1265775.png?semt=ais_hybrid" alt="Detail Icon" class="w-5 h-5 mr-2"> Detail
                              </a>
                              <form action="/delete-food/${food.pk}" method="post" class="inline">
                                  <input type="hidden" name="csrfmiddlewaretoken" value="{{ csrf_token }}">
                                  <button type="submit" class="bg-red-500 hover:bg-red-600 text-white text-sm font-bold py-2 px-6 rounded-lg">
                                      <img src="https://cdn-icons-png.flaticon.com/512/484/484662.png" alt="Delete Icon" class="w-5 h-5 mr-2"> Delete
                                  </button>
                              </form>
                          </div>
                      </div>
                  </div>
              `;
          });
      }

      // Append new content to the food_entry_list
      foodEntryList.innerHTML = htmlString;

      // Optionally, scroll to the top of the new list
      window.scrollTo({ top: 0, behavior: 'smooth' });
  } catch (error) {
      console.error("Error in refreshing food entries:", error);
  }
}

</script>
{% endblock content %}
